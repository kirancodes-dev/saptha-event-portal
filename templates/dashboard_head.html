{% extends "base.html" %}

{% block content %}

{% if event %}
<div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
    <div>
        <h2 class="fw-bold text-dark mb-0" style="font-family: 'Cinzel', serif;">{{ event.name }}</h2>
        <span class="badge bg-dark mt-2">Coordinator Console</span>
        <span class="badge {{ 'bg-success' if event.is_published else 'bg-warning text-dark' }} ms-1">
            {{ 'LIVE' if event.is_published else 'PRE-EVENT' }}
        </span>
    </div>
    <div class="text-end">
        <a href="/event_head/download_report" class="btn btn-outline-primary btn-sm fw-bold">
            <i class="fas fa-download me-2"></i> Download Report
        </a>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3"><div class="card p-3 border-start border-4 border-warning shadow-sm"><h6 class="text-muted small">Pending Approval</h6><h3 class="mb-0">{{ analytics.pending }}</h3></div></div>
    <div class="col-md-3"><div class="card p-3 border-start border-4 border-success shadow-sm"><h6 class="text-muted small">Approved Teams</h6><h3 class="mb-0">{{ analytics.approved }}</h3></div></div>
    <div class="col-md-3"><div class="card p-3 border-start border-4 border-primary shadow-sm"><h6 class="text-muted small">Checked In</h6><h3 class="mb-0">{{ analytics.present }}</h3></div></div>
    <div class="col-md-3"><div class="card p-3 border-start border-4 border-info shadow-sm"><h6 class="text-muted small">Submissions</h6><h3 class="mb-0">{{ analytics.submissions }}</h3></div></div>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-bottom-0">
        <ul class="nav nav-tabs card-header-tabs" id="coordTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active fw-bold" id="tab-reg" data-bs-toggle="tab" data-bs-target="#content-reg">1. Registrations</button></li>
            <li class="nav-item"><button class="nav-link fw-bold" id="tab-exec" data-bs-toggle="tab" data-bs-target="#content-exec">2. Execution</button></li>
            <li class="nav-item"><button class="nav-link fw-bold" id="tab-comm" data-bs-toggle="tab" data-bs-target="#content-comm">3. Communication</button></li>
            <li class="nav-item"><button class="nav-link fw-bold" id="tab-manage" data-bs-toggle="tab" data-bs-target="#content-manage">4. Manage</button></li>
        </ul>
    </div>
    
    <div class="card-body p-4 tab-content">
        
        <div class="tab-pane fade show active" id="content-reg">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="bg-light">
                        <tr>
                            <th>Team Code</th>
                            <th>Team & Members</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for team in teams %}
                        <tr>
                            <td class="fw-bold text-primary">{{ team.code }}</td>
                            <td>
                                <div class="fw-bold">{{ team.name }}</div>
                                <div class="small text-muted">
                                    {% for m in team.members %}{{ m.name }}{{ "," if not loop.last }}{% endfor %}
                                </div>
                            </td>
                            <td>
                                {% if team.approval_status == 'Approved' %}<span class="badge bg-success">Approved</span>
                                {% elif team.approval_status == 'Rejected' %}<span class="badge bg-danger">Rejected</span>
                                {% else %}<span class="badge bg-warning text-dark">Pending</span>{% endif %}
                            </td>
                            <td>
                                {% if team.approval_status == 'Pending' %}
                                <div class="d-flex gap-2">
                                    <form action="/event_head/manage_registration/{{ team.id }}/approve" method="POST">
                                        <button class="btn btn-sm btn-success"><i class="fas fa-check"></i></button>
                                    </form>
                                    <form action="/event_head/manage_registration/{{ team.id }}/reject" method="POST">
                                        <button class="btn btn-sm btn-danger"><i class="fas fa-times"></i></button>
                                    </form>
                                </div>
                                {% else %}
                                <span class="text-muted small">Processed</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="text-center text-muted py-4">No registrations yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="content-exec">
            <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">Attendance & Submission Tracking</h6>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead class="bg-light">
                        <tr>
                            <th>Team</th>
                            <th>Attendance</th>
                            <th>Submission Status</th>
                            <th>Verify</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for team in teams %}
                        {% if team.approval_status == 'Approved' %}
                        <tr>
                            <td class="fw-bold">{{ team.name }}</td>
                            <td>
                                <form action="/event_head/mark_attendance/{{ team.id }}" method="POST">
                                    {% if team.attendance_status == 'Present' %}
                                        <button class="btn btn-success btn-sm rounded-pill px-3"><i class="fas fa-user-check me-1"></i> Present</button>
                                    {% else %}
                                        <button class="btn btn-outline-secondary btn-sm rounded-pill px-3"><i class="fas fa-user-clock me-1"></i> Absent</button>
                                    {% endif %}
                                </form>
                            </td>
                            <td>
                                {% if team.project_link %}
                                    <a href="{{ team.project_link }}" target="_blank" class="badge bg-info text-dark text-decoration-none">
                                        <i class="fas fa-link me-1"></i> View Project
                                    </a>
                                {% else %}
                                    <span class="badge bg-light text-muted border">Not Submitted</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-dark" onclick="alert('Verification feature coming soon')"><i class="fas fa-search"></i> Verify</button>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="content-comm">
            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-light border-0 p-3">
                        <h6 class="fw-bold mb-3">ðŸ“¢ Broadcast Announcement</h6>
                        <form action="/event_head/add_announcement" method="POST">
                            <textarea name="message" class="form-control mb-3" rows="3" placeholder="e.g. 'Lunch is being served'..." required></textarea>
                            <button class="btn btn-dark w-100"><i class="fas fa-paper-plane me-2"></i>Send to All Participants</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6 class="fw-bold mb-3">Recent Announcements</h6>
                    <ul class="list-group">
                        {% for ann in event.announcements %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ ann.message }}</span>
                            <small class="text-muted">{{ ann.timestamp.strftime('%H:%M') }}</small>
                        </li>
                        {% else %}
                        <li class="list-group-item text-center text-muted">No announcements sent.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="content-manage">
            {% if event.category == 'Tech' %}
                <h6 class="text-primary fw-bold mb-3">Problem Statements</h6>
                <button class="btn btn-primary btn-sm mb-3" data-bs-toggle="modal" data-bs-target="#addPSModal">+ Add Problem</button>
                <ul class="list-group">
                    {% for ps in event.problems %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span><span class="badge bg-light text-dark border me-2">{{ ps.uid }}</span> {{ ps.title }}</span>
                        <form action="/event_head/delete_problem/{{ ps.id }}" method="POST"><button class="btn btn-sm text-danger"><i class="fas fa-trash"></i></button></form>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">No specific management tools configured for this category.</p>
            {% endif %}
        </div>

    </div>
</div>

<div class="modal fade" id="addPSModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white"><h5 class="modal-title">Add Challenge</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <form action="/event_head/add_problem" method="POST">
                <div class="modal-body">
                    <input type="text" name="ps_title" class="form-control mb-2" placeholder="Title" required>
                    <textarea name="ps_desc" class="form-control" rows="3" placeholder="Description"></textarea>
                </div>
                <div class="modal-footer"><button class="btn btn-primary w-100">Add</button></div>
            </form>
        </div>
    </div>
</div>

{% else %}
<div class="text-center py-5">
    <i class="fas fa-user-clock fa-4x text-muted opacity-25 mb-3"></i>
    <h3>No Event Assigned Yet</h3>
    <p class="text-muted">Please contact your Club SPOC to get assigned to an event.</p>
    {% if user_id %}
    <div class="alert alert-info d-inline-block mt-3">
        <i class="fas fa-info-circle me-1"></i> Your Coordinator ID is: <strong>{{ user_id }}</strong><br>
        Ask the SPOC to verify this ID is assigned to the event.
    </div>
    {% endif %}
</div>
{% endif %}

{% endblock %}