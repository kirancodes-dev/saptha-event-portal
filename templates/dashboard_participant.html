{% extends "base.html" %}

{% block content %}

<style>
    :root {
        --dash-primary: #002147;
        --dash-accent: #C5A065;
        --card-radius: 12px;
    }

    /* Hero Banner */
    .dashboard-hero {
        background: linear-gradient(135deg, var(--dash-primary) 0%, #0f3460 100%);
        color: white;
        padding: 2.5rem 2rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 33, 71, 0.25);
    }
    .dashboard-hero::after {
        content: '';
        position: absolute;
        top: 0; right: 0; width: 300px; height: 100%;
        background: url('https://www.transparenttextures.com/patterns/cubes.png');
        opacity: 0.1;
        pointer-events: none;
    }

    /* Event Cards */
    .event-card {
        border: none;
        border-radius: var(--card-radius);
        background: white;
        transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
        border-left: 5px solid #e0e0e0; /* Default Border */
        box-shadow: 0 4px 6px rgba(0,0,0,0.02);
    }
    .event-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.08);
    }
    .event-card.status-primary { border-left-color: #0d6efd; } /* Registered */
    .event-card.status-success { border-left-color: #198754; } /* Submitted/Ongoing */
    .event-card.status-dark { border-left-color: #212529; }   /* Completed */
    .event-card.status-danger { border-left-color: #dc3545; } /* Urgent */

    /* Profile Card */
    .profile-card {
        border: none;
        border-radius: 16px;
        overflow: hidden;
        background: white;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }
    .profile-header-bg {
        height: 100px;
        background: linear-gradient(to right, #C5A065, #dfbd83);
    }
    .profile-avatar {
        width: 90px; height: 90px;
        background: var(--dash-primary);
        color: white;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 2.5rem; font-weight: 700;
        border: 4px solid white;
        margin: -45px auto 1rem auto; /* Pull up */
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* Stats Box */
    .stat-box {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
    }
    .stat-label { font-size: 0.7rem; text-transform: uppercase; color: #6c757d; font-weight: bold; }
    .stat-value { font-size: 1.1rem; font-weight: 700; color: var(--dash-primary); }

    /* Timeline Notifications */
    .notif-item {
        border-left: 3px solid #eee;
        padding-left: 15px;
        margin-left: 10px;
        padding-bottom: 20px;
        position: relative;
    }
    .notif-item::before {
        content: '';
        width: 10px; height: 10px;
        background: var(--dash-accent);
        border-radius: 50%;
        position: absolute;
        left: -6.5px;
        top: 5px;
    }
    .notif-item:last-child { border-left: none; }
</style>

<div class="dashboard-hero d-flex justify-content-between align-items-center">
    <div style="z-index: 2;">
        <h2 class="fw-bold mb-1" style="font-family: 'Cinzel', serif;">Student Portal</h2>
        <p class="mb-0 opacity-75">Welcome back, <span class="fw-bold text-warning">{{ participant.name }}</span></p>
    </div>
    <a href="/" class="btn btn-light text-primary fw-bold rounded-pill px-4 shadow-sm" style="z-index: 2;">
        <i class="fas fa-compass me-2"></i>Browse Events
    </a>
</div>

<div class="row g-5">
    
    <div class="col-lg-8">
        
        <ul class="nav nav-pills mb-4" id="pills-tab">
            <li class="nav-item"><button class="btn btn-sm btn-dark rounded-pill me-2 px-3 active">All Events</button></li>
            <li class="nav-item"><button class="btn btn-sm btn-outline-secondary rounded-pill me-2 px-3">Ongoing</button></li>
            <li class="nav-item"><button class="btn btn-sm btn-outline-secondary rounded-pill px-3">Completed</button></li>
        </ul>

        <h5 class="fw-bold text-dark mb-4"><i class="fas fa-layer-group me-2 text-primary"></i>My Registered Events</h5>
        
        {% if my_events_data %}
            <div class="d-flex flex-column gap-3">
                {% for item in my_events_data %}
                
                <div class="event-card p-4 status-{{ item.status_class }}">
                    <div class="row align-items-center">
                        
                        <div class="col-md-7 mb-3 mb-md-0">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <span class="badge bg-{{ item.status_class }} bg-opacity-10 text-{{ item.status_class }} px-2 py-1 rounded-1" style="font-size: 0.7rem;">
                                    <i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i> {{ item.status }}
                                </span>
                                <small class="text-muted"><i class="far fa-clock me-1"></i> {{ item.event.date.strftime('%d %b, %I:%M %p') }}</small>
                            </div>
                            <h4 class="fw-bold mb-1 text-dark">{{ item.event.name }}</h4>
                            <p class="text-muted small mb-0"><i class="fas fa-map-marker-alt me-1"></i> {{ item.event.venue }}</p>

                            {% if item.team %}
                            <div class="mt-3 d-flex align-items-center gap-3">
                                <div class="d-flex align-items-center bg-light px-3 py-1 rounded-pill border">
                                    <i class="fas fa-users text-secondary me-2"></i>
                                    <span class="fw-bold text-dark small">{{ item.team.name }}</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-md-5 text-md-end">
                            <div class="d-flex flex-column gap-2 align-items-md-end">
                                <a href="/event/{{ item.event.id }}" class="btn btn-outline-dark btn-sm rounded-pill fw-bold w-100" style="max-width: 160px;">View Details</a>
                                
                                {% if item.event.category == 'Tech' and item.status != 'Completed' %}
                                    {% if item.has_submission %}
                                        <button class="btn btn-success btn-sm rounded-pill fw-bold w-100 disabled" style="max-width: 160px;">
                                            <i class="fas fa-check-circle me-1"></i> Submitted
                                        </button>
                                    {% else %}
                                        <button class="btn btn-primary btn-sm rounded-pill fw-bold w-100 shadow-sm" style="max-width: 160px;" data-bs-toggle="modal" data-bs-target="#submitModal{{ item.team.id }}">
                                            <i class="fas fa-cloud-upload-alt me-1"></i> Submit Project
                                        </button>
                                    {% endif %}
                                {% endif %}

                                {% if item.status == 'Completed' %}
                                    <button class="btn btn-warning btn-sm rounded-pill fw-bold w-100 text-dark" style="max-width: 160px;">
                                        <i class="fas fa-award me-1"></i> Certificate
                                    </button>
                                {% endif %}
                            </div>
                        </div>

                    </div>
                </div>

                {% if item.team %}
                <div class="modal fade" id="submitModal{{ item.team.id }}" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">Project Submission</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <form action="/participant/submit_project" method="POST">
                                <div class="modal-body p-4">
                                    <input type="hidden" name="team_id" value="{{ item.team.id }}">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold small text-uppercase">Project Link (GitHub/Drive)</label>
                                        <input type="url" name="project_link" class="form-control" placeholder="https://..." required>
                                    </div>
                                    <div class="alert alert-light border small text-muted">
                                        Ensure your repository is public or accessible to judges.
                                    </div>
                                </div>
                                <div class="modal-footer border-0 bg-light">
                                    <button class="btn btn-dark w-100 fw-bold">Submit Final Project</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5 bg-white rounded-3 shadow-sm border border-dashed">
                <i class="fas fa-calendar-plus fa-3x text-muted opacity-25 mb-3"></i>
                <h5 class="fw-bold text-dark">No Events Yet</h5>
                <p class="text-muted">You haven't registered for any events.</p>
                <a href="/" class="btn btn-primary btn-sm fw-bold px-4 rounded-pill">Explore Events</a>
            </div>
        {% endif %}
    </div>

    <div class="col-lg-4">
        
        <div class="profile-card mb-4 position-sticky" style="top: 100px;">
            <div class="profile-header-bg"></div>
            <div class="profile-avatar shadow">
                {{ participant.name[0] }}
            </div>
            
            <div class="text-center px-4 pb-4">
                <h5 class="fw-bold text-dark mb-1">{{ participant.name }}</h5>
                <p class="text-muted small mb-3">{{ participant.usn }}</p>
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="stat-box">
                            <div class="stat-value">{{ my_events_data|length }}</div>
                            <div class="stat-label">Events</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-box">
                            <div class="stat-value">{{ participant.department }}</div>
                            <div class="stat-label">Dept</div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-outline-dark w-100 rounded-pill btn-sm fw-bold">Edit Profile</button>
            </div>
        </div>

        <div class="bg-white p-4 rounded-4 shadow-sm">
            <h6 class="fw-bold mb-4 border-bottom pb-2">Recent Updates</h6>
            <div class="mt-3">
                {% for notif in notifications %}
                <div class="notif-item">
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold small text-dark">{{ notif.event.name }}</span>
                        <span class="text-muted" style="font-size: 0.65rem;">{{ notif.timestamp.strftime('%H:%M') }}</span>
                    </div>
                    <p class="text-muted small mb-0 mt-1" style="line-height: 1.4;">{{ notif.message }}</p>
                </div>
                {% else %}
                <div class="text-center text-muted small py-2">No new notifications.</div>
                {% endfor %}
            </div>
        </div>

    </div>

</div>

{% endblock %}